#!/bin/sh

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)

echo "-----> Installing go"
cd $cache
wget -qO go.tar.gz https://redirector.gvt1.com/edgedl/go/go1.9.2.linux-amd64.tar.gz
tar zxf go.tar.gz

echo "-----> Installing node"
cd $cache
mkdir node
wget -qO node.tar.xz https://nodejs.org/dist/v9.7.0/node-v9.7.0-linux-x64.tar.xz
tar Jxf node.tar.xz -C node --strip-components 1

echo "-----> Setup environment"
export GOROOT=$cache/go
export GOPATH=$cache/gopath
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin:$cache/node/bin

echo "-----> Setup GOPATH"
proj=$GOPATH/src/github.com/traPtitech
repo=$proj/traQ
mkdir -p $proj
ln -sf $build $repo

echo "-----> Setup project"
cd $repo
git submodule update --init
make init

echo "-----> Build project"
go build -v -o traq

echo "-----> Setup UI"
cd $repo/client
npm install

echo "-----> Build UI"
npm run build
