version: 2

jobs:
  build:
    docker:
      - image: circleci/golang:latest
      - image: circleci/mysql:latest-ram
        environment:
          - MYSQL_DATABASE=traq
          - MYSQL_ROOT_PASSWORD=password

    working_directory: /go/src/github.com/traPtitech/traQ

    steps:
      - checkout

      - run:
          name: Install tools/packages
          command: |
            go get -u github.com/golang/dep/cmd/dep
            go get -u github.com/golang/lint/golint
            dep ensure

      - run:
          name: gofmt
          when: always
          command: (! gofmt -s -d `find . -path "./vendor" -prune -o -type f -name "*.go" -print` | grep ^)
      - run:
          name: golint
          when: always
          command: golint -set_exit_status
      - run:
          name: go vet
          when: always
          command: go vet ./...

      - run:
          name: Wait for DB
          command: dockerize -wait tcp://localhost:3306 -timeout 1m

      - run:
          name: go test
          when: always
          command: go test ./...
      - run:
          name: go build
          when: always
          command: go build -o traq

      - store_artifacts:
          path: /go/src/github.com/traPtitech/traQ/traq
          destination: traq
